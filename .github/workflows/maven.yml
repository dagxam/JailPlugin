# ╔══════════════════════════════════════════════╗
# ║   Автоматическая сборка плагина JailPlugin   ║
# ╚══════════════════════════════════════════════╝
#
# Этот файл автоматически собирает плагин при каждом пуше
# или пулл-реквесте. Готовый .jar можно скачать
# во вкладке Actions → Artifacts.

name: Сборка JailPlugin

# ────────────────────────────────────────────────
#  КОГДА ЗАПУСКАТЬ СБОРКУ
# ────────────────────────────────────────────────
on:
  # При пуше в основную ветку
  push:
    branches:
      - main
      - master
    # Собираем только если изменились исходники или pom.xml
    paths:
      - 'src/**'
      - 'pom.xml'

  # При создании пулл-реквеста
  pull_request:
    branches:
      - main
      - master

  # Ручной запуск из интерфейса GitHub (вкладка Actions → Run workflow)
  workflow_dispatch:

# ────────────────────────────────────────────────
#  ЗАДАЧИ СБОРКИ
# ────────────────────────────────────────────────
jobs:
  build:
    # Название задачи в интерфейсе GitHub
    name: 🔨 Сборка плагина

    # Операционная система для сборки
    runs-on: ubuntu-latest

    steps:
      # ── Шаг 1: Клонирование репозитория ──
      - name: 📥 Клонирование репозитория
        uses: actions/checkout@v4

      # ── Шаг 2: Установка Java 17 ──
      # Используем Temurin (бывший AdoptOpenJDK) — самый популярный
      # Для Paper/Spigot 1.20+ нужна Java 17 или выше
      - name: ☕ Установка Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # Кэширование зависимостей Maven (ускоряет повторные сборки)
          cache: 'maven'

      # ── Шаг 3: Сборка проекта через Maven ──
      # -B        — неинтерактивный режим (без вопросов)
      # --no-transfer-progress — не показывать прогресс скачивания
      # package   — собрать .jar файл
      # -DskipTests — пропустить тесты (если есть)
      - name: 🔧 Сборка через Maven
        run: mvn -B --no-transfer-progress clean package -DskipTests

      # ── Шаг 4: Загрузка готового .jar как артефакт ──
      # После сборки файл можно скачать:
      #   GitHub → Actions → выбрать запуск → Artifacts
      - name: 📦 Загрузка артефакта (готовый плагин)
        uses: actions/upload-artifact@v4
        with:
          # Название архива с артефактом
          name: JailPlugin
          # Путь к собранному .jar файлу
          path: target/JailPlugin.jar
          # Хранить артефакт 30 дней
          retention-days: 30

      # ── Шаг 5: Показать информацию о сборке ──
      - name: ✅ Информация о сборке
        run: |
          echo "══════════════════════════════════════"
          echo "  Сборка завершена успешно!"
          echo "══════════════════════════════════════"
          echo ""
          echo "Файл: target/JailPlugin.jar"
          echo "Размер: $(du -h target/JailPlugin.jar | cut -f1)"
          echo "Дата: $(date '+%d.%m.%Y %H:%M:%S')"
          echo "Коммит: ${{ github.sha }}"
          echo ""
          echo "Скачайте плагин во вкладке Artifacts ↑"
